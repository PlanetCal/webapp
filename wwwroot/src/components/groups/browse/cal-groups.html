<link rel="import" href="/src/polymer-refs.html">
<link rel="import" href="/src/components/groups/browse/cal-group.html">
<link rel="import" href="group-styles.html">

<dom-module id="cal-groups">
  <template>
    <style include="group-styles" is=""></style>

    <iron-ajax url="[[url]]" last-response="{{data}}" auto on-response="handleAjaxResponse"></iron-ajax>
    <iron-ajax id='ajax' handle-as='json' url="[[ajaxUrl]]" on-error='handleErrorResponse' on-response='handleAjaxResponse'></iron-ajax>
    <template is="dom-if" if="[[rootRow]]">
      <paper-tabs class='paper-tabs' selected="{{selectedTab}}">
        <template is="dom-repeat" items="[[data]]">
          <paper-tab>
            <cal-group id="[[item.id]]" name="[[item.name]]" icon="[[item.icon]]"></cal-group>
          </paper-tab>
        </template>
      </paper-tabs>
    </template>

    <template is="dom-if" if="[[!rootRow]]">
      <iron-selector selected="{{selectedTab}}" role='navigation'>
        <template is="dom-repeat" items="[[data]]">
          <div>
            <cal-group id="[[item.id]]" name="[[item.name]]" icon="[[item.icon]]" check-state=4 show-expander=0></cal-group>
          </div>
        </template>
      </iron-selector>
    </template>
  </template>
  <script>
    Polymer({
      is: 'cal-groups',

      properties: {
        id: { type: String },
        selectedTab: { type: Number, observer: '_selectionChanged' },
        parentGroupId: { type: String, observer: '_dataChanged' },
        rootRow: { type: Boolean, value: false }
      },

      ready: function () {
        this.selectedTab = 0;
        this._dataChanged();
      },

      _dataChanged: function () {
        if (this.id === 'rootRow') {
          this.url = "/src/components/groups/browse/mockdata/groups.json";
        } else if (this.parentGroupId !== null && this.parentGroupId !== '' && this.parentGroupId !== undefined) {
          var ajax = this.$.ajax;
          var serviceBaseUrl = Polymer.globalsManager.globals.serviceBaseUrl;
          var loggedInUser = Polymer.globalsManager.globals.loggedInUser;
          if (loggedInUser) {
            ajax.headers['Authorization'] = 'Bearer ' + loggedInUser.token;
            ajax.method = 'GET';
            ajax.headers['Version'] = '1.0';

            // this.ajaxUrl = serviceBaseUrl + "/groups" + this.parentGroupId;
            if (this.id === 'firstRow') {
              this.ajaxUrl = serviceBaseUrl + "/groups?fields=name|icon|childGroups&filter=category=" + this.parentGroupId;
            } else {
              this.ajaxUrl = serviceBaseUrl + "/groups?fields=name|icon|childGroups&filter=parentGroup=" + this.parentGroupId;
            }

            ajax.generateRequest();
          } else {
            this.fire("status-message-update", { severity: 'error', message: 'User is not logged in.' });
          }
        }
      },

      _selectionChanged: function () {
        if (this.data != null && this.data.length > 0) {
          this.selectedGroupId = this.data[this.selectedTab].id;
          //console.log("id:" + this.id + ", selectedTab:" + this.selectedTab + ",selectedGroupId:" + this.selectedGroupId)
          this.fire('on-group-selected', { groupsId: this.id, selectedGroupId: this.selectedGroupId })
        }
      },

      handleAjaxResponse: function (e) {
        this.data = e.detail.response;
        this._selectionChanged();
      },

      handleErrorResponse: function (e) {
        var jsonResponse = e.detail.request.xhr.response;
        this.displayErrorMessage(jsonResponse);
      },

      displayErrorMessage: function (errorResponse) {
        var message = '';
        if (errorResponse !== null) {
          switch (errorResponse.errorcode) {
            case 'GenericHttpRequestException':
              message = 'Oh! ohh! Looks like there is some internal issue. Please try again after some time.';
              break;
            default:
              message = errorResponse.errorcode + ' has not been handled yet.';
              break;
          }
        } else {
          message = 'Something went wrong.';
        }
        this.fire("status-message-update", { severity: 'error', message: message });
      },
    });
  </script>
</dom-module>